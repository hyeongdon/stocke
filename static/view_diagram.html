<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í‚¤ì›€ì¦ê¶Œ ìë™ë§¤ë§¤ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 40px;
            border-left: 4px solid #4CAF50;
            padding-left: 15px;
        }
        .mermaid {
            background-color: white;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow-x: auto;
        }
        .nav {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-height: 80vh;
            overflow-y: auto;
        }
        .nav h3 {
            margin-top: 0;
            color: #4CAF50;
        }
        .nav a {
            display: block;
            padding: 8px 12px;
            margin: 5px 0;
            text-decoration: none;
            color: #333;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .nav a:hover {
            background-color: #e8f5e9;
        }
        .info {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }
    </style>
</head>
<body>
    <div class="nav">
        <h3>ëª©ì°¨</h3>
        <a href="#diagram1">1. ì‹œìŠ¤í…œ ì „ì²´ ì•„í‚¤í…ì²˜</a>
        <a href="#diagram2">2. ë°ì´í„°ë² ì´ìŠ¤ ER ë‹¤ì´ì–´ê·¸ë¨</a>
        <a href="#diagram3">3. í”„ë¡œì„¸ìŠ¤ í”Œë¡œìš°</a>
        <a href="#diagram4">4. ì „ëµë³„ ë§¤ë§¤ ë¡œì§</a>
        <a href="#diagram5">5. API ì—”ë“œí¬ì¸íŠ¸ êµ¬ì¡°</a>
        <a href="#diagram6">6. ì»´í¬ë„ŒíŠ¸ ìƒí˜¸ì‘ìš©</a>
        <a href="#diagram7">7. ë°ì´í„° íë¦„ë„</a>
        <a href="#diagram8">8. ëª¨ë‹ˆí„°ë§ ì£¼ê¸°</a>
    </div>

    <div class="container">
        <h1>í‚¤ì›€ì¦ê¶Œ ìë™ë§¤ë§¤ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨</h1>
        
        <div class="info">
            <strong>ğŸ’¡ ì‚¬ìš© ë°©ë²•:</strong> ì´ HTML íŒŒì¼ì„ ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ ì—´ë©´ ëª¨ë“  ë‹¤ì´ì–´ê·¸ë¨ì´ ìë™ìœ¼ë¡œ ë Œë”ë§ë©ë‹ˆë‹¤. 
            ì¸í„°ë„· ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤ (Mermaid.js CDN ì‚¬ìš©).
        </div>

        <h2 id="diagram1">1. ì‹œìŠ¤í…œ ì „ì²´ ì•„í‚¤í…ì²˜</h2>
        <div class="mermaid">
graph TB
    subgraph "Frontend Layer"
        UI[Web UI<br/>static/index.html<br/>app.js]
        UI_MODULES[UI Modules<br/>- account-manager.js<br/>- chart-manager.js<br/>- condition-manager.js<br/>- strategy-manager.js<br/>- ui-utils.js]
        UI --> UI_MODULES
    end

    subgraph "API Layer"
        API[FastAPI Server<br/>main.py]
        API_ROUTES[API Endpoints<br/>- /monitoring/*<br/>- /strategy/*<br/>- /scalping/*<br/>- /watchlist/*<br/>- /trading/*<br/>- /chart/*]
        API --> API_ROUTES
    end

    subgraph "Business Logic Layer"
        COND_MON[ConditionMonitor<br/>condition_monitor.py<br/>ì¡°ê±´ì‹ ëª¨ë‹ˆí„°ë§<br/>10ë¶„ ì£¼ê¸°]
        STRAT_MGR[StrategyManager<br/>strategy_manager.py<br/>ì „ëµ ë§¤ë§¤<br/>1ë¶„ ì£¼ê¸°]
        SCALP_MGR[ScalpingStrategy<br/>scalping_strategy.py<br/>ìŠ¤ìº˜í•‘ ì „ëµ<br/>30ì´ˆ ì£¼ê¸°]
        STOP_LOSS[StopLossManager<br/>stop_loss_manager.py<br/>ì†ì ˆ/ìµì ˆ<br/>30ì´ˆ ì£¼ê¸°]
        WATCH_SYNC[WatchlistSync<br/>watchlist_sync_manager.py<br/>ê´€ì‹¬ì¢…ëª© ë™ê¸°í™”<br/>5ë¶„ ì£¼ê¸°]
        SIG_MGR[SignalManager<br/>signal_manager.py<br/>ì‹ í˜¸ ê´€ë¦¬]
        BUY_EXEC[BuyOrderExecutor<br/>buy_order_executor.py<br/>ë§¤ìˆ˜ ì£¼ë¬¸ ì‹¤í–‰]
        CLEANUP[CleanupScheduler<br/>cleanup_scheduler.py<br/>ìì • ì •ë¦¬]
    end

    subgraph "Data Layer"
        DB[(SQLite Database<br/>stock_pipeline.db)]
        TABLES[Tables<br/>- pending_buy_signals<br/>- watchlist_stocks<br/>- trading_strategies<br/>- strategy_signals<br/>- positions<br/>- sell_orders<br/>- auto_trade_conditions<br/>- auto_trade_settings]
        DB --> TABLES
    end

    subgraph "External Services"
        KIWOOM[Kiwoom API<br/>REST + WebSocket]
        NAVER[Naver API<br/>ë‰´ìŠ¤ ê²€ìƒ‰]
        NAVER_CRAWL[Naver Crawler<br/>í† ë¡  í¬ë¡¤ë§]
    end

    subgraph "Infrastructure"
        TOKEN_MGR[TokenManager<br/>token_manager.py<br/>ì¸ì¦ í† í° ê´€ë¦¬]
        RATE_LIMIT[APIRateLimiter<br/>api_rate_limiter.py<br/>API ì œí•œ ê´€ë¦¬]
        CONFIG[Config<br/>config.py<br/>í™˜ê²½ ì„¤ì •]
    end

    UI -->|HTTP/HTTPS| API
    API --> COND_MON
    API --> STRAT_MGR
    API --> SCALP_MGR
    API --> STOP_LOSS
    API --> WATCH_SYNC
    API --> SIG_MGR
    API --> BUY_EXEC
    API --> CLEANUP

    COND_MON --> SIG_MGR
    STRAT_MGR --> SIG_MGR
    SCALP_MGR --> SIG_MGR
    SIG_MGR --> DB
    BUY_EXEC --> DB
    STOP_LOSS --> DB
    WATCH_SYNC --> DB

    COND_MON -->|ì¡°ê±´ì‹ ì¡°íšŒ| KIWOOM
    STRAT_MGR -->|ì°¨íŠ¸ ë°ì´í„°| KIWOOM
    SCALP_MGR -->|í˜„ì¬ê°€ ì¡°íšŒ| KIWOOM
    STOP_LOSS -->|í˜„ì¬ê°€/ë§¤ë„| KIWOOM
    WATCH_SYNC -->|ì¡°ê±´ì‹ ì¢…ëª©| KIWOOM
    BUY_EXEC -->|ë§¤ìˆ˜ ì£¼ë¬¸| KIWOOM
    API -->|ë‰´ìŠ¤ ê²€ìƒ‰| NAVER
    API -->|í† ë¡  í¬ë¡¤ë§| NAVER_CRAWL

    KIWOOM --> TOKEN_MGR
    KIWOOM --> RATE_LIMIT
    TOKEN_MGR --> CONFIG
    RATE_LIMIT --> CONFIG
        </div>

        <h2 id="diagram2">2. ë°ì´í„°ë² ì´ìŠ¤ ER ë‹¤ì´ì–´ê·¸ë¨</h2>
        <div class="mermaid">
erDiagram
    AUTO_TRADE_CONDITIONS ||--o{ PENDING_BUY_SIGNALS : "has"
    AUTO_TRADE_SETTINGS ||--o{ PENDING_BUY_SIGNALS : "configures"
    WATCHLIST_STOCKS ||--o{ STRATEGY_SIGNALS : "generates"
    TRADING_STRATEGIES ||--o{ STRATEGY_SIGNALS : "produces"
    PENDING_BUY_SIGNALS ||--o| POSITIONS : "creates"
    POSITIONS ||--o{ SELL_ORDERS : "triggers"
    AUTO_TRADE_CONDITIONS ||--o{ WATCHLIST_STOCKS : "syncs"
    CONDITION_WATCHLIST_SYNC }o--|| AUTO_TRADE_CONDITIONS : "tracks"

    AUTO_TRADE_CONDITIONS {
        int id PK
        string condition_name UK
        string api_condition_id
        boolean is_enabled
        datetime updated_at
    }

    AUTO_TRADE_SETTINGS {
        int id PK
        boolean is_enabled
        int max_invest_amount
        int stop_loss_rate
        int take_profit_rate
        datetime updated_at
    }

    PENDING_BUY_SIGNALS {
        int id PK
        int condition_id FK
        string stock_code
        string stock_name
        datetime detected_at
        date detected_date
        string status
        string signal_type
        int reference_candle_high
        datetime reference_candle_date
        int target_price
    }

    WATCHLIST_STOCKS {
        int id PK
        string stock_code UK
        string stock_name
        datetime added_at
        boolean is_active
        string source_type
        int condition_id FK
        string condition_name
    }

    TRADING_STRATEGIES {
        int id PK
        string strategy_name UK
        string strategy_type
        boolean is_enabled
        json parameters
        datetime updated_at
    }

    STRATEGY_SIGNALS {
        int id PK
        int strategy_id FK
        string stock_code
        string stock_name
        string signal_type
        float signal_value
        datetime detected_at
        date detected_date
        string status
        json additional_data
    }

    POSITIONS {
        int id PK
        string stock_code
        string stock_name
        int buy_price
        int buy_quantity
        int buy_amount
        string buy_order_id
        int actual_buy_amount
        float stop_loss_rate
        float take_profit_rate
        int stop_loss_price
        int take_profit_price
        string status
        int current_price
        int current_profit_loss
        float current_profit_loss_rate
        datetime buy_time
        datetime sell_time
        datetime last_monitored
        int condition_id FK
        int signal_id FK
    }

    SELL_ORDERS {
        int id PK
        int position_id FK
        string stock_code
        string stock_name
        int sell_price
        int sell_quantity
        int sell_amount
        string sell_reason
        string sell_reason_detail
        int profit_loss
        float profit_loss_rate
        string status
        datetime created_at
        datetime ordered_at
        datetime completed_at
    }

    CONDITION_WATCHLIST_SYNC {
        int id PK
        int condition_id FK
        string condition_name
        string stock_code
        string stock_name
        string sync_status
        datetime last_sync_at
        boolean added_to_watchlist
    }
        </div>

        <h2 id="diagram3">3. í”„ë¡œì„¸ìŠ¤ í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨</h2>
        <div class="mermaid">
flowchart TD
    START([ì‹œìŠ¤í…œ ì‹œì‘]) --> INIT[ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™”]
    INIT --> AUTH[í‚¤ì›€ API ì¸ì¦]
    AUTH --> WS_CONN{WebSocket<br/>ì—°ê²°}
    WS_CONN -->|ì„±ê³µ| WS_OK[WebSocket ì—°ê²° ì„±ê³µ]
    WS_CONN -->|ì‹¤íŒ¨| REST_ONLY[REST APIë§Œ ì‚¬ìš©]
    WS_OK --> START_SERVICES
    REST_ONLY --> START_SERVICES

    START_SERVICES[ë°±ê·¸ë¼ìš´ë“œ ì„œë¹„ìŠ¤ ì‹œì‘] --> START_BUY[ë§¤ìˆ˜ ì£¼ë¬¸ ì‹¤í–‰ê¸° ì‹œì‘]
    START_BUY --> START_STOP[ì†ì ˆ/ìµì ˆ ëª¨ë‹ˆí„°ë§ ì‹œì‘]
    START_STOP --> START_CLEANUP[ìì • ì •ë¦¬ ìŠ¤ì¼€ì¤„ëŸ¬ ì‹œì‘]
    START_CLEANUP --> READY[ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ]

    READY --> MONITORING{ëª¨ë‹ˆí„°ë§<br/>í™œì„±í™”?}
    
    MONITORING -->|ì¡°ê±´ì‹ ëª¨ë‹ˆí„°ë§| COND_LOOP[10ë¶„ ì£¼ê¸° ë£¨í”„]
    COND_LOOP --> COND_CHECK[ì¡°ê±´ì‹ ëª©ë¡ ì¡°íšŒ]
    COND_CHECK --> COND_ENABLED{í™œì„±í™”ëœ<br/>ì¡°ê±´ì‹?}
    COND_ENABLED -->|ìˆìŒ| COND_SEARCH[ì¡°ê±´ì‹ ì¢…ëª© ê²€ìƒ‰]
    COND_SEARCH --> COND_STRATEGY[ê¸°ì¤€ë´‰ ì „ëµ ì ìš©]
    COND_STRATEGY --> COND_SIGNAL{ì‹ í˜¸<br/>ìƒì„±?}
    COND_SIGNAL -->|ìƒì„±| SAVE_SIGNAL[ì‹ í˜¸ ì €ì¥<br/>PENDING ìƒíƒœ]
    COND_SIGNAL -->|ì—†ìŒ| COND_LOOP
    SAVE_SIGNAL --> COND_LOOP
    COND_ENABLED -->|ì—†ìŒ| COND_LOOP

    MONITORING -->|ì „ëµ ë§¤ë§¤| STRAT_LOOP[1ë¶„ ì£¼ê¸° ë£¨í”„]
    STRAT_LOOP --> STRAT_WATCH[ê´€ì‹¬ì¢…ëª© ì¡°íšŒ]
    STRAT_WATCH --> STRAT_CHART[ì°¨íŠ¸ ë°ì´í„° ì¡°íšŒ]
    STRAT_CHART --> STRAT_CALC[ì „ëµ ê³„ì‚°<br/>ëª¨ë©˜í…€/ì´ê²©ë„/ë³¼ë¦°ì €/RSI]
    STRAT_CALC --> STRAT_SIGNAL{ë§¤ìˆ˜/ë§¤ë„<br/>ì‹ í˜¸?}
    STRAT_SIGNAL -->|ìˆìŒ| SAVE_SIGNAL
    STRAT_SIGNAL -->|ì—†ìŒ| STRAT_LOOP

    MONITORING -->|ìŠ¤ìº˜í•‘ ì „ëµ| SCALP_LOOP[30ì´ˆ ì£¼ê¸° ë£¨í”„]
    SCALP_LOOP --> SCALP_CHECK[í™œì„± ì¢…ëª© í™•ì¸]
    SCALP_CHECK --> SCALP_PRICE[í˜„ì¬ê°€ ì¡°íšŒ]
    SCALP_PRICE --> SCALP_SIGNAL{ìŠ¤ìº˜í•‘<br/>ì‹ í˜¸?}
    SCALP_SIGNAL -->|ìˆìŒ| SAVE_SIGNAL
    SCALP_SIGNAL -->|ì—†ìŒ| SCALP_LOOP

    MONITORING -->|ì†ì ˆ/ìµì ˆ| STOP_LOOP[30ì´ˆ ì£¼ê¸° ë£¨í”„]
    STOP_LOOP --> STOP_POS[ë³´ìœ  ì¢…ëª© ì¡°íšŒ]
    STOP_POS --> STOP_PRICE[í˜„ì¬ê°€ ì¡°íšŒ]
    STOP_PRICE --> STOP_CHECK{ì†ì ˆ/ìµì ˆ<br/>ì¡°ê±´?}
    STOP_CHECK -->|ë§Œì¡±| STOP_SELL[ë§¤ë„ ì£¼ë¬¸ ì‹¤í–‰]
    STOP_CHECK -->|ë¶ˆë§Œì¡±| STOP_LOOP
    STOP_SELL --> STOP_UPDATE[í¬ì§€ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸]
    STOP_UPDATE --> STOP_LOOP

    MONITORING -->|ê´€ì‹¬ì¢…ëª© ë™ê¸°í™”| SYNC_LOOP[5ë¶„ ì£¼ê¸° ë£¨í”„]
    SYNC_LOOP --> SYNC_COND[ì¡°ê±´ì‹ ì¢…ëª© ì¡°íšŒ]
    SYNC_COND --> SYNC_UPDATE[ê´€ì‹¬ì¢…ëª© DB ì—…ë°ì´íŠ¸]
    SYNC_UPDATE --> SYNC_API[í‚¤ì›€ ê´€ì‹¬ì¢…ëª© ì¶”ê°€]
    SYNC_API --> SYNC_LOOP

    SAVE_SIGNAL --> BUY_PROCESS[ë§¤ìˆ˜ ì£¼ë¬¸ ì²˜ë¦¬]
    BUY_PROCESS --> BUY_CHECK[PENDING ì‹ í˜¸ ì¡°íšŒ]
    BUY_CHECK --> BUY_VALID{ì‹ í˜¸<br/>ìœ íš¨?}
    BUY_VALID -->|ìœ íš¨| BUY_PRICE[í˜„ì¬ê°€ ì¡°íšŒ]
    BUY_PRICE --> BUY_CALC[ìˆ˜ëŸ‰ ê³„ì‚°]
    BUY_CALC --> BUY_ORDER[ë§¤ìˆ˜ ì£¼ë¬¸ ì‹¤í–‰]
    BUY_ORDER --> BUY_RESULT{ì£¼ë¬¸<br/>ì„±ê³µ?}
    BUY_RESULT -->|ì„±ê³µ| BUY_UPDATE[ìƒíƒœ: ORDERED<br/>í¬ì§€ì…˜ ìƒì„±]
    BUY_RESULT -->|ì‹¤íŒ¨| BUY_RETRY{ì¬ì‹œë„<br/>ê°€ëŠ¥?}
    BUY_RETRY -->|ê°€ëŠ¥| BUY_WAIT[30ì´ˆ ëŒ€ê¸°]
    BUY_WAIT --> BUY_ORDER
    BUY_RETRY -->|ë¶ˆê°€ëŠ¥| BUY_FAIL[ìƒíƒœ: FAILED]
    BUY_VALID -->|ë¬´íš¨| BUY_PROCESS
    BUY_UPDATE --> POS_CREATE[í¬ì§€ì…˜ ìƒì„±<br/>HOLDING ìƒíƒœ<br/>actual_buy_amount ì €ì¥]
    POS_CREATE --> POS_MONITOR[ì†ì ˆ/ìµì ˆ ëª¨ë‹ˆí„°ë§<br/>2ë¶„ ì£¼ê¸°]
    POS_MONITOR --> POS_CHECK{ì†ì ˆ/ìµì ˆ<br/>ì¡°ê±´?}
    POS_CHECK -->|ì†ì ˆ| STOP_LOSS[ë§¤ë„ ì£¼ë¬¸<br/>STOP_LOSS]
    POS_CHECK -->|ìµì ˆ| TAKE_PROFIT[ë§¤ë„ ì£¼ë¬¸<br/>TAKE_PROFIT]
    POS_CHECK -->|ìˆ˜ë™| MANUAL_SELL[ë§¤ë„ ì£¼ë¬¸<br/>MANUAL_SELL]
    POS_CHECK -->|ë³´ìœ | POS_MONITOR
    STOP_LOSS --> LIQUIDATION[ì²­ì‚° ì™„ë£Œ<br/>ìˆ˜ìµ/ì†ì‹¤ í™•ì •<br/>sell_order ìƒì„±]
    TAKE_PROFIT --> LIQUIDATION
    MANUAL_SELL --> LIQUIDATION
    LIQUIDATION --> BUY_PROCESS
    BUY_FAIL --> BUY_PROCESS
        </div>

        <h2 id="diagram4">4. ì „ëµë³„ ë§¤ë§¤ ë¡œì§ í”Œë¡œìš°</h2>
        <div class="mermaid">
flowchart TD
    START([ì „ëµ ëª¨ë‹ˆí„°ë§ ì‹œì‘]) --> LOAD[ê´€ì‹¬ì¢…ëª© ë¡œë“œ]
    LOAD --> LOOP[ê° ì¢…ëª© ìˆœíšŒ]
    LOOP --> CHART[ì°¨íŠ¸ ë°ì´í„° ì¡°íšŒ<br/>5ë¶„ë´‰]
    CHART --> CACHE{ìºì‹œ<br/>ìœ íš¨?}
    CACHE -->|ìœ íš¨| USE_CACHE[ìºì‹œ ì‚¬ìš©]
    CACHE -->|ë¬´íš¨| FETCH[API í˜¸ì¶œ]
    FETCH --> USE_CACHE

    USE_CACHE --> STRATEGY{ì „ëµ<br/>ì„ íƒ}
    
    STRATEGY -->|ëª¨ë©˜í…€| MOMENTUM[ëª¨ë©˜í…€ ê³„ì‚°<br/>ì¢…ê°€ - nì¼ì „ ì¢…ê°€]
    MOMENTUM --> MOM_CHECK{ëª¨ë©˜í…€ > 0<br/>AND ìƒìŠ¹ ì¶”ì„¸?}
    MOM_CHECK -->|ì˜ˆ| MOM_BUY[ë§¤ìˆ˜ ì‹ í˜¸]
    MOM_CHECK -->|ì•„ë‹ˆì˜¤| NEXT

    STRATEGY -->|ì´ê²©ë„| DISPARITY[ì´ê²©ë„ ê³„ì‚°<br/>í˜„ì¬ê°€ / ì´ë™í‰ê·  * 100]
    DISPARITY --> DISP_CHECK{ì´ê²©ë„ < 95%<br/>ë§¤ìˆ˜ OR > 105% ë§¤ë„?}
    DISP_CHECK -->|ë§¤ìˆ˜| DISP_BUY[ë§¤ìˆ˜ ì‹ í˜¸]
    DISP_CHECK -->|ë§¤ë„| DISP_SELL[ë§¤ë„ ì‹ í˜¸]
    DISP_CHECK -->|ì—†ìŒ| NEXT

    STRATEGY -->|ë³¼ë¦°ì €ë°´ë“œ| BOLLINGER[ë³¼ë¦°ì €ë°´ë“œ ê³„ì‚°<br/>MA Â± 2Ïƒ]
    BOLLINGER --> BOL_CHECK{í•˜ë‹¨ë°´ë“œ í„°ì¹˜<br/>í›„ ë°˜ë“±?}
    BOL_CHECK -->|ì˜ˆ| BOL_BUY[ë§¤ìˆ˜ ì‹ í˜¸]
    BOL_CHECK -->|ì•„ë‹ˆì˜¤| NEXT

    STRATEGY -->|RSI| RSI[RSI ê³„ì‚°<br/>14ì¼ ê¸°ì¤€]
    RSI --> RSI_VOL[ê±°ë˜ëŸ‰ í™•ì¸<br/>ê°€ì¤‘í‰ê·  * 1.5ë°°]
    RSI_VOL --> RSI_CHECK{RSI < 30<br/>AND ìƒìŠ¹ ì „í™˜<br/>AND ê±°ë˜ëŸ‰ ì¦ê°€?}
    RSI_CHECK -->|ì˜ˆ| RSI_BUY[ë§¤ìˆ˜ ì‹ í˜¸]
    RSI_CHECK -->|ì•„ë‹ˆì˜¤| RSI_CHECK2{RSI > 70<br/>AND í•˜ë½ ì „í™˜<br/>AND ê±°ë˜ëŸ‰ ì¦ê°€?}
    RSI_CHECK2 -->|ì˜ˆ| RSI_SELL[ë§¤ë„ ì‹ í˜¸]
    RSI_CHECK2 -->|ì•„ë‹ˆì˜¤| NEXT

    STRATEGY -->|ì°¨ì´í‚¨| CHAIKIN[ì°¨ì´í‚¨ ì˜¤ì‹¤ë ˆì´í„°<br/>ê³„ì‚°]
    CHAIKIN --> CHK_CHECK{ì˜¤ì‹¤ë ˆì´í„°<br/>0ì„  ìƒí–¥ ëŒíŒŒ?}
    CHK_CHECK -->|ì˜ˆ| CHK_BUY[ë§¤ìˆ˜ ì‹ í˜¸]
    CHK_CHECK -->|ì•„ë‹ˆì˜¤| NEXT

    MOM_BUY --> SAVE
    DISP_BUY --> SAVE
    DISP_SELL --> SAVE_SELL
    BOL_BUY --> SAVE
    RSI_BUY --> SAVE
    RSI_SELL --> SAVE_SELL
    CHK_BUY --> SAVE

    SAVE[ì‹ í˜¸ ì €ì¥<br/>SignalManager] --> NEXT[ë‹¤ìŒ ì¢…ëª©]
    SAVE_SELL[ë§¤ë„ ì‹ í˜¸ ì €ì¥] --> NEXT
    NEXT --> MORE{ë” ë§ì€<br/>ì¢…ëª©?}
    MORE -->|ì˜ˆ| LOOP
    MORE -->|ì•„ë‹ˆì˜¤| WAIT[1ë¶„ ëŒ€ê¸°]
    WAIT --> LOAD
        </div>

        <h2 id="diagram5">5. API ì—”ë“œí¬ì¸íŠ¸ êµ¬ì¡°</h2>
        <div class="mermaid">
graph LR
    API[FastAPI Server] --> MON[ëª¨ë‹ˆí„°ë§ API]
    API --> STRAT[ì „ëµ API]
    API --> SCALP[ìŠ¤ìº˜í•‘ API]
    API --> WATCH[ê´€ì‹¬ì¢…ëª© API]
    API --> TRADE[ë§¤ë§¤ API]
    API --> CHART[ì°¨íŠ¸ API]
    API --> ACCOUNT[ê³„ì¢Œ API]
    API --> SIGNAL[ì‹ í˜¸ API]

    MON --> MON1[POST /monitoring/start]
    MON --> MON2[POST /monitoring/stop]
    MON --> MON3[GET /monitoring/status]

    STRAT --> STRAT1[POST /strategy/start]
    STRAT --> STRAT2[POST /strategy/stop]
    STRAT --> STRAT3[GET /strategy/status]
    STRAT --> STRAT4[GET /strategies/]
    STRAT --> STRAT5[POST /strategies/{type}/configure]

    SCALP --> SCALP1[POST /scalping/start]
    SCALP --> SCALP2[POST /scalping/stop]
    SCALP --> SCALP3[GET /scalping/status]

    WATCH --> WATCH1[GET /watchlist/]
    WATCH --> WATCH2[POST /watchlist/add]
    WATCH --> WATCH3[DELETE /watchlist/{code}]
    WATCH --> WATCH4[POST /watchlist/sync/start]

    TRADE --> TRADE1[POST /trading/buy]
    TRADE --> TRADE2[GET /trading/settings]
    TRADE --> TRADE3[POST /trading/settings]
    TRADE --> TRADE4[GET /positions/]
    TRADE --> TRADE5[POST /positions/update-prices]
    TRADE --> TRADE6[POST /positions/sync-actual-buy-amount]

    CHART --> CHART1[GET /chart/image/{code}]
    CHART --> CHART2[GET /chart/strategy/{code}/{type}]
    CHART --> CHART3[GET /stocks/{code}/info]

    ACCOUNT --> ACC1[GET /account/balance]
    ACCOUNT --> ACC2[GET /account/holdings]
    ACCOUNT --> ACC3[GET /account/profit]

    SIGNAL --> SIG1[GET /signals/pending]
    SIGNAL --> SIG2[GET /signals/statistics]
    SIGNAL --> SIG3[GET /signals/by-strategy/{id}]
        </div>

        <h2 id="diagram6">6. ì»´í¬ë„ŒíŠ¸ ìƒí˜¸ì‘ìš© ì‹œí€€ìŠ¤</h2>
        <div class="mermaid">
sequenceDiagram
    autonumber
    participant User as ì‚¬ìš©ì
    participant UI as Web UI
    participant API as FastAPI
    participant CondMon as ConditionMonitor
    participant StratMgr as StrategyManager
    participant SigMgr as SignalManager
    participant BuyExec as BuyOrderExecutor
    participant StopLoss as StopLossManager
    participant DB as Database
    participant Kiwoom as Kiwoom API

    User->>UI: ëª¨ë‹ˆí„°ë§ ì‹œì‘ í´ë¦­
    UI->>API: POST /monitoring/start
    API->>CondMon: start_periodic_monitoring()
    CondMon->>CondMon: 10ë¶„ ì£¼ê¸° ë£¨í”„ ì‹œì‘

    loop 10ë¶„ë§ˆë‹¤
        CondMon->>Kiwoom: ì¡°ê±´ì‹ ëª©ë¡ ì¡°íšŒ
        Kiwoom-->>CondMon: ì¡°ê±´ì‹ ëª©ë¡ ë°˜í™˜
        CondMon->>Kiwoom: ì¡°ê±´ì‹ ì¢…ëª© ê²€ìƒ‰
        Kiwoom-->>CondMon: ì¢…ëª© ëª©ë¡ ë°˜í™˜
        CondMon->>CondMon: ê¸°ì¤€ë´‰ ì „ëµ ì ìš©
        CondMon->>SigMgr: create_signal()
        SigMgr->>DB: INSERT pending_buy_signals
    end

    User->>UI: ì „ëµ ë§¤ë§¤ ì‹œì‘ í´ë¦­
    UI->>API: POST /strategy/start
    API->>StratMgr: start_strategy_monitoring()
    StratMgr->>StratMgr: 1ë¶„ ì£¼ê¸° ë£¨í”„ ì‹œì‘

    loop 1ë¶„ë§ˆë‹¤
        StratMgr->>DB: SELECT ê´€ì‹¬ì¢…ëª©
        DB-->>StratMgr: ê´€ì‹¬ì¢…ëª© ëª©ë¡
        loop ê° ì¢…ëª©
            StratMgr->>Kiwoom: ì°¨íŠ¸ ë°ì´í„° ì¡°íšŒ
            Kiwoom-->>StratMgr: ì°¨íŠ¸ ë°ì´í„°
            StratMgr->>StratMgr: ì „ëµ ê³„ì‚°
            alt ì‹ í˜¸ ë°œìƒ
                StratMgr->>SigMgr: create_signal()
                SigMgr->>DB: INSERT pending_buy_signals
            end
        end
    end

    BuyExec->>BuyExec: ë°±ê·¸ë¼ìš´ë“œ ì£¼ë¬¸ ì²˜ë¦¬ ë£¨í”„
    loop ì§€ì†ì ìœ¼ë¡œ
        BuyExec->>DB: SELECT PENDING ì‹ í˜¸
        DB-->>BuyExec: PENDING ì‹ í˜¸ ëª©ë¡
        BuyExec->>Kiwoom: í˜„ì¬ê°€ ì¡°íšŒ
        Kiwoom-->>BuyExec: í˜„ì¬ê°€
        BuyExec->>BuyExec: ìˆ˜ëŸ‰ ê³„ì‚°
        BuyExec->>Kiwoom: ë§¤ìˆ˜ ì£¼ë¬¸
        alt ì£¼ë¬¸ ì„±ê³µ
            Kiwoom-->>BuyExec: ì£¼ë¬¸ ì„±ê³µ
            BuyExec->>DB: UPDATE status=ORDERED
            BuyExec->>DB: INSERT positions
        else ì£¼ë¬¸ ì‹¤íŒ¨
            BuyExec->>DB: UPDATE status=FAILED
        end
    end

    StopLoss->>StopLoss: 2ë¶„ ì£¼ê¸° ëª¨ë‹ˆí„°ë§ ë£¨í”„
    loop 2ë¶„ë§ˆë‹¤
        StopLoss->>DB: SELECT ë³´ìœ  ì¢…ëª© (HOLDING)
        DB-->>StopLoss: í¬ì§€ì…˜ ëª©ë¡
        loop ê° í¬ì§€ì…˜
            StopLoss->>Kiwoom: í˜„ì¬ê°€ ì¡°íšŒ
            Kiwoom-->>StopLoss: í˜„ì¬ê°€
            StopLoss->>StopLoss: í‰ê°€ì†ìµ ê³„ì‚°<br/>(ë§¤ë„ ìˆ˜ìˆ˜ë£Œ + ì œì„¸ê¸ˆ í¬í•¨)
            StopLoss->>DB: UPDATE current_profit_loss
            StopLoss->>StopLoss: ì†ì ˆ/ìµì ˆ ì¡°ê±´ í™•ì¸
            alt ì¡°ê±´ ë§Œì¡±
                StopLoss->>Kiwoom: ë§¤ë„ ì£¼ë¬¸
                Kiwoom-->>StopLoss: ì£¼ë¬¸ ì„±ê³µ
                StopLoss->>DB: UPDATE í¬ì§€ì…˜ ìƒíƒœ<br/>(STOP_LOSS/TAKE_PROFIT/MANUAL_SELL)
                StopLoss->>DB: INSERT sell_orders
                StopLoss->>StopLoss: ì²­ì‚° ì™„ë£Œ<br/>(ìˆ˜ìµ/ì†ì‹¤ í™•ì •)
            end
        end
    end
        </div>

        <h2 id="diagram7">7. ë°ì´í„° íë¦„ë„</h2>
        <div class="mermaid">
flowchart LR
    subgraph "ë°ì´í„° ì…ë ¥"
        KIWOOM_API[í‚¤ì›€ API<br/>ì¡°ê±´ì‹/ì°¨íŠ¸/ì‹œì„¸]
        NAVER_API[ë„¤ì´ë²„ API<br/>ë‰´ìŠ¤/í† ë¡ ]
    end

    subgraph "ë°ì´í„° ì²˜ë¦¬"
        COND_PROC[ì¡°ê±´ì‹ ì²˜ë¦¬]
        STRAT_PROC[ì „ëµ ì²˜ë¦¬]
        SIGNAL_PROC[ì‹ í˜¸ ì²˜ë¦¬]
    end

    subgraph "ë°ì´í„° ì €ì¥"
        PENDING_TBL[(pending_buy_signals)]
        WATCH_TBL[(watchlist_stocks)]
        STRAT_TBL[(trading_strategies)]
        SIGNAL_TBL[(strategy_signals)]
        POS_TBL[(positions)]
        SELL_TBL[(sell_orders)]
    end

    subgraph "ë°ì´í„° ì¶œë ¥"
        UI_DASH[ì›¹ ëŒ€ì‹œë³´ë“œ]
        CHART_IMG[ì°¨íŠ¸ ì´ë¯¸ì§€]
        API_RESP[API ì‘ë‹µ]
    end

    KIWOOM_API --> COND_PROC
    KIWOOM_API --> STRAT_PROC
    NAVER_API --> UI_DASH

    COND_PROC --> SIGNAL_PROC
    STRAT_PROC --> SIGNAL_PROC
    SIGNAL_PROC --> PENDING_TBL

    COND_PROC --> WATCH_TBL
    STRAT_PROC --> STRAT_TBL
    STRAT_PROC --> SIGNAL_TBL

    PENDING_TBL --> POS_TBL
    POS_TBL --> SELL_TBL

    PENDING_TBL --> UI_DASH
    WATCH_TBL --> UI_DASH
    STRAT_TBL --> UI_DASH
    SIGNAL_TBL --> UI_DASH
    POS_TBL --> UI_DASH
    SELL_TBL --> UI_DASH

    KIWOOM_API --> CHART_IMG
    CHART_IMG --> UI_DASH

    PENDING_TBL --> API_RESP
    WATCH_TBL --> API_RESP
    STRAT_TBL --> API_RESP
    POS_TBL --> API_RESP
        </div>

        <h2 id="diagram8">8. ëª¨ë‹ˆí„°ë§ ì£¼ê¸° ë° íƒ€ì´ë°</h2>
        <div class="mermaid">
gantt
    title ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ ì£¼ê¸°
    dateFormat X
    axisFormat %sì´ˆ

    section ì¡°ê±´ì‹ ëª¨ë‹ˆí„°ë§
    ì¡°ê±´ì‹ ìŠ¤ìº” (10ë¶„ ì£¼ê¸°)    :0, 600s
    ì¡°ê±´ì‹ ìŠ¤ìº” (10ë¶„ ì£¼ê¸°)    :600, 600s
    ì¡°ê±´ì‹ ìŠ¤ìº” (10ë¶„ ì£¼ê¸°)    :1200, 600s

    section ì „ëµ ë§¤ë§¤
    ì „ëµ ìŠ¤ìº” (1ë¶„ ì£¼ê¸°)       :0, 60s
    ì „ëµ ìŠ¤ìº” (1ë¶„ ì£¼ê¸°)       :60, 60s
    ì „ëµ ìŠ¤ìº” (1ë¶„ ì£¼ê¸°)       :120, 60s

    section ìŠ¤ìº˜í•‘ ì „ëµ
    ìŠ¤ìº˜í•‘ ìŠ¤ìº” (30ì´ˆ ì£¼ê¸°)    :0, 30s
    ìŠ¤ìº˜í•‘ ìŠ¤ìº” (30ì´ˆ ì£¼ê¸°)    :30, 30s
    ìŠ¤ìº˜í•‘ ìŠ¤ìº” (30ì´ˆ ì£¼ê¸°)    :60, 30s

    section ì†ì ˆ/ìµì ˆ
    ì†ì ˆ/ìµì ˆ ëª¨ë‹ˆí„°ë§ (30ì´ˆ ì£¼ê¸°) :0, 30s
    ì†ì ˆ/ìµì ˆ ëª¨ë‹ˆí„°ë§ (30ì´ˆ ì£¼ê¸°) :30, 30s
    ì†ì ˆ/ìµì ˆ ëª¨ë‹ˆí„°ë§ (30ì´ˆ ì£¼ê¸°) :60, 30s

    section ê´€ì‹¬ì¢…ëª© ë™ê¸°í™”
    ë™ê¸°í™” (5ë¶„ ì£¼ê¸°)          :0, 300s
    ë™ê¸°í™” (5ë¶„ ì£¼ê¸°)          :300, 300s
    ë™ê¸°í™” (5ë¶„ ì£¼ê¸°)          :600, 300s
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                diagramMarginX: 50,
                diagramMarginY: 10,
                actorMargin: 50,
                width: 150,
                height: 65,
                boxMargin: 10,
                boxTextMargin: 5,
                noteMargin: 10,
                messageMargin: 35
            }
        });
    </script>
</body>
</html>

