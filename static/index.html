<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>통합 모니터링</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css?v=4">
    <style>
        .stock-item {
            cursor: pointer !important;
            transition: all 0.2s ease;
            user-select: none;
        }
        .stock-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background-color: #f8f9fa !important;
        }
        .nav-tabs .nav-link {
            font-weight: 500;
        }
        /* 사용 테마 색상에 맡기기 위해 활성 탭 커스텀 제거 */
        .tab-content {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <header class="bg-primary text-white p-3 mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">통합 모니터링</h1>
                <div id="selectedStockInfo" class="selected-stock-info" style="display: none;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-chart-line me-2"></i>
                        <span id="selectedStockName" class="fw-bold"></span>
                        <span id="selectedStockCode" class="ms-2 text-light opacity-75"></span>
                        <button class="btn btn-outline-light btn-sm ms-3" id="clearSelection">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- 탭 메뉴 -->
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="stocks-tab" data-bs-toggle="tab" data-bs-target="#stocks-pane" type="button" role="tab" aria-controls="stocks-pane" aria-selected="true">
                    <i class="fas fa-chart-line me-2"></i>종목/조건식
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="strategy-tab" data-bs-toggle="tab" data-bs-target="#strategy-pane" type="button" role="tab" aria-controls="strategy-pane" aria-selected="false">
                    <i class="fas fa-chart-bar me-2"></i>전략매매
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="account-tab" data-bs-toggle="tab" data-bs-target="#account-pane" type="button" role="tab" aria-controls="account-pane" aria-selected="false">
                    <i class="fas fa-wallet me-2"></i>계좌/매매
                </button>
            </li>
        </ul>

        <!-- 탭 컨텐츠 -->
        <div class="tab-content" id="mainTabContent">
            <!-- 종목/조건식 탭 -->
            <div class="tab-pane fade show active" id="stocks-pane" role="tabpanel" aria-labelledby="stocks-tab">
                <!-- 상단: 조건식과 종목 정보 -->
                <div class="row stocks-main-row">
                    <!-- 조건식 목록 -->
                    <div class="col-md-4">
                        <div class="card conditions-card">
                            <div class="card-header">
                                <span>조건식 목록</span>
                                <button class="btn btn-outline-primary btn-sm" id="refreshConditions">
                                    <i class="fas fa-sync-alt"></i> 새로고침
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="conditions-list-container">
                                    <div class="list-group" id="conditionsList">
                                        <!-- 조건식 목록이 여기에 동적으로 추가됩니다 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 종목 정보 -->
                    <div class="col-md-8">
                        <div class="card stocks-card">
                            <div class="card-header">
                                <span>종목 정보</span>
                                <div>
                                    <button class="btn btn-outline-primary btn-sm me-2" id="refreshStocks">
                                        <i class="fas fa-sync-alt"></i> 새로고침
                                    </button>
                                    <button class="btn btn-success btn-sm" id="toggleMonitoring">
                                        <i class="fas fa-play"></i> <span id="monitoringText">모니터링 시작</span>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="stocksContent" class="stocks-container">
                                    <div class="text-center text-muted py-5">
                                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                                        <p>조건식을 선택하여 종목 정보를 확인하세요.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 하단: 뉴스 섹션 (항상 표시) -->
                <div class="row mt-3" id="newsSection">
                    <div class="col-12">
                        <div class="card news-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-newspaper text-primary me-2"></i>
                                    <h5 class="mb-0 fw-bold">관련 뉴스</h5>
                                </div>
                                <span id="newsStockName" class="badge bg-primary fs-6">종목을 선택하세요</span>
                            </div>
                            <div class="card-body">
                                <div id="newsContent">
                                    <div class="text-center text-muted py-3">
                                        <i class="fas fa-newspaper fa-2x mb-2"></i>
                                        <p class="mb-0">종목을 클릭하여 관련 뉴스를 확인하세요.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 전략매매 탭 -->
            <div class="tab-pane fade" id="strategy-pane" role="tabpanel" aria-labelledby="strategy-tab">
                <div class="row">
                    <!-- 왼쪽: 관심종목 관리 -->
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-heart me-2"></i>관심종목 관리</span>
                                <button class="btn btn-outline-primary btn-sm" id="refreshWatchlist">
                                    <i class="fas fa-sync-alt"></i> 새로고침
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- 관심종목 추가 폼 -->
                                <div class="mb-3">
                                    <div class="row">
                                        <div class="col-5">
                                            <input type="text" class="form-control" id="addStockCode" placeholder="종목코드 (예: 005930)">
                                        </div>
                                        <div class="col-5">
                                            <input type="text" class="form-control" id="addStockName" placeholder="종목명 (예: 삼성전자)">
                                        </div>
                                        <div class="col-2">
                                            <button class="btn btn-success btn-sm w-100" id="addToWatchlist">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 관심종목 목록 -->
                                <div id="watchlistContainer" style="max-height: 300px; overflow-y: auto;">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-heart fa-2x mb-2"></i>
                                        <p>관심종목이 없습니다.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 전략 모니터링 상태 -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-robot me-2"></i>전략 모니터링</span>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="strategyMonitoringToggle">
                                    <label class="form-check-label" for="strategyMonitoringToggle">
                                        모니터링
                                    </label>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="strategyStatus">
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <h6 class="text-muted mb-1">상태</h6>
                                            <span id="strategyStatusText" class="badge bg-secondary">중지</span>
                                        </div>
                                        <div class="col-6">
                                            <h6 class="text-muted mb-1">실행 시간</h6>
                                            <small id="strategyRunTime" class="text-muted">-</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 오른쪽: 전략 설정 -->
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">
                                <span><i class="fas fa-cogs me-2"></i>전략 설정</span>
                            </div>
                            <div class="card-body">
                                <div id="strategiesContainer">
                                    <!-- 전략 설정 카드들이 여기에 동적으로 추가됩니다 -->
                                </div>
                            </div>
                        </div>

                        <!-- 전략 신호 히스토리 -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-signal me-2"></i>전략 신호</span>
                                <button class="btn btn-outline-secondary btn-sm" id="refreshStrategySignals">
                                    <i class="fas fa-sync-alt"></i> 새로고침
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="strategySignalsContainer" style="max-height: 300px; overflow-y: auto;">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-signal fa-2x mb-2"></i>
                                        <p>전략 신호가 없습니다.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 계좌/매매 탭 -->
            <div class="tab-pane fade" id="account-pane" role="tabpanel" aria-labelledby="account-tab">
                <div class="row">
                    <!-- 왼쪽 컬럼: 계좌 정보 및 손익 -->
                    <div class="col-md-6">
                        <div class="card account-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-user-circle me-2"></i>계좌 정보</span>
                                <button class="btn btn-outline-primary btn-sm" id="refreshAccount">
                                    <i class="fas fa-sync-alt"></i> 새로고침
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="accountInfo">
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <strong>계좌명:</strong>
                                            <span id="accountName" class="text-muted">-</span>
                                        </div>
                                        <div class="col-6">
                                            <strong>지점명:</strong>
                                            <span id="branchName" class="text-muted">-</span>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <strong>예수금:</strong>
                                            <span id="deposit" class="text-muted">-</span>
                                        </div>
                                        <div class="col-6">
                                            <strong>가용현금:</strong>
                                            <span id="availableCash" class="text-muted">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 계좌 손익 -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <span><i class="fas fa-chart-pie me-2"></i>계좌 손익</span>
                            </div>
                            <div class="card-body">
                                <div id="accountProfitLoss">
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <div class="border-end">
                                                <h6 class="text-muted mb-1">총 자산</h6>
                                                <h5 id="totalAssets" class="mb-0">-</h5>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="border-end">
                                                <h6 class="text-muted mb-1">평가 손익</h6>
                                                <h5 id="totalProfitLoss" class="mb-0">-</h5>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <h6 class="text-muted mb-1">수익률</h6>
                                            <h5 id="profitRate" class="mb-0">-</h5>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 보유 종목 -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <span><i class="fas fa-briefcase me-2"></i>보유 종목</span>
                            </div>
                            <div class="card-body">
                                <div id="holdingsList" style="max-height: 400px; overflow-y: auto;">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-chart-pie fa-2x mb-2"></i>
                                        <p>보유 종목이 없습니다.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 계좌 수익현황 (ka10085) -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <span><i class="fas fa-receipt me-2"></i>보유종목 수익현황</span>
                            </div>
                            <div class="card-body">
                                <div id="account-profit">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-table fa-2x mb-2"></i>
                                        <p>표시할 데이터가 없습니다.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 오른쪽 컬럼: 자동매매 설정 및 매수대기 목록 -->
                    <div class="col-md-6">
                        <!-- 매수대기 목록 -->
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-list me-2"></i>매수대기 목록</span>
                                <button class="btn btn-outline-secondary btn-sm" id="refreshPending">
                                    <i class="fas fa-sync-alt"></i> 새로고침
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="pendingList" style="max-height: 260px; overflow-y: auto;">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-2x mb-2"></i>
                                        <p>매수대기 종목이 없습니다.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card trading-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-robot me-2"></i>자동매매 설정</span>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="autoTradingToggle">
                                    <label class="form-check-label" for="autoTradingToggle">
                                        자동매매
                                    </label>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="tradingSettings">
                                    <div class="mb-3">
                                        <label for="maxInvestAmount" class="form-label">최대 투자 금액</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="maxInvestAmount" placeholder="1000000">
                                            <span class="input-group-text">원</span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="stopLossRate" class="form-label">손절 비율</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="stopLossRate" placeholder="5" step="0.1">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="takeProfitRate" class="form-label">익절 비율</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="takeProfitRate" placeholder="10" step="0.1">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary w-100" id="saveTradingSettings">
                                        <i class="fas fa-save me-2"></i>설정 저장
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 최근 매매 내역 -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <span><i class="fas fa-history me-2"></i>최근 매매 내역</span>
                            </div>
                            <div class="card-body">
                                <div id="tradingHistory" style="max-height: 400px; overflow-y: auto;">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-history fa-2x mb-2"></i>
                                        <p>매매 내역이 없습니다.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <!-- 기존 모달들 유지 -->
    <!-- 로딩 모달 -->
    <div class="modal fade" id="loadingModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">로딩 중...</span>
                    </div>
                    <p class="mt-2 mb-0">데이터를 불러오는 중...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 차트 모달 -->
    <div class="modal fade" id="chartModal" tabindex="-1" aria-labelledby="chartModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen-lg-down modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chartModalLabel">주가 차트</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h6 id="chartStockName" class="mb-0">종목명</h6>
                            <small id="chartStockCode" class="text-muted">종목코드</small>
                        </div>
                        <div class="btn-group me-2" role="group">
                            <input type="radio" class="btn-check" name="chartPeriod" id="period1D" value="1D" checked>
                            <label class="btn btn-outline-primary btn-sm" for="period1D">1일</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="period1W" value="1W">
                            <label class="btn btn-outline-primary btn-sm" for="period1W">1주</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="period1M" value="1M">
                            <label class="btn btn-outline-primary btn-sm" for="period1M">1개월</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="period1Y" value="1Y">
                            <label class="btn btn-outline-primary btn-sm" for="period1Y">1년</label>
                        </div>
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-success btn-sm" onclick="chartManager.showStrategyChart('MOMENTUM')">
                                <i class="fas fa-chart-line"></i> 모멘텀
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="chartManager.showStrategyChart('DISPARITY')">
                                <i class="fas fa-percentage"></i> 이격도
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="chartManager.showStrategyChart('BOLLINGER')">
                                <i class="fas fa-chart-area"></i> 볼린저
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="chartManager.showStrategyChart('RSI')">
                                <i class="fas fa-wave-square"></i> RSI
                            </button>
                        </div>
                    </div>
                    <div id="chartContainer" style="height: 60vh; min-height: 400px;">
                        <div class="text-center p-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">차트 로딩 중...</span>
                            </div>
                            <p class="mt-2 mb-0">차트를 불러오는 중...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 디버그 로그 영역 -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050; max-width: 400px;">
        <div class="card" id="debugLog" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <small class="fw-bold">디버그 로그</small>
                <button type="button" class="btn-close btn-close-sm" onclick="document.getElementById('debugLog').style.display='none'"></button>
            </div>
            <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                <div id="debugLogContent" style="font-size: 0.8rem;"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script>
        // 간단한 테스트 스크립트
        console.log('페이지 로드됨');
        
        // 기본 앱 객체 생성
        window.app = {
            selectStockForNews: function(code, name) {
                console.log('뉴스 선택:', code, name);
            }
        };
    </script>
    <!-- 모듈들을 순서대로 로드 -->
    <script src="modules/ui-utils.js"></script>
    <script src="modules/condition-manager.js"></script>
    <script src="modules/account-manager.js"></script>
    <script src="modules/chart-manager.js"></script>
    <script src="modules/strategy-manager.js"></script>
    <script src="app.js"></script>
</body>
</html>